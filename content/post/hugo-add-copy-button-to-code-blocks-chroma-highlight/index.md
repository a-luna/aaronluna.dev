---
title: 'Hugo: Add Copy-to-Clipboard Button to Code Blocks with Vanilla JS'
slug: hugo-add-copy-button-to-code-blocks-chroma-highlight
date: '2019-11-13'
menu_section: "blog"
categories:
  - Hugo
  - JavaScript
summary: "Hugo includes a built-in syntax-highlighter called Chroma. Chroma is extremely fast since it is written in pure Go (like Hugo) and supports every language I can think of. Chroma's speed is especially important since syntax highlighters are notorious for causing slow page loads. However, it lacks one vital feature — an easy way to copy a code block to the clipboard. I decided to document my implementation using only vanilla JS since every blog post I found for this issue relied on jquery to parse the DOM, which is a shame. We can do better, people."
resources:
  - name: cover
    src: images/cover.jpg
    params:
      credit: "Photo by Natalia Y on Unsplash"
---

Hugo includes <a href="https://gohugo.io/content-management/syntax-highlighting/" target="_blank">a built-in syntax-highlighter called Chroma</a>. Chroma is extremely fast since it is written in pure Go (like Hugo) and supports every language I can think of. Chroma's speed is especially important since syntax highlighters are notorious for causing slow page loads. However, it lacks one vital feature — an easy way to copy a code block to the clipboard. I decided to document my implementation using only vanilla JS (every blog post I found for this issue relied on jquery to parse the DOM, which is a shame. We can do better, people).

A quick search led me to <a href="https://www.dannyguo.com/blog/how-to-add-copy-to-clipboard-buttons-to-code-blocks-in-hugo/" target="_blank">this post</a> on Danny Guo's blog. I used his example as my starting point but made several changes:

<ul>
  <li>The "copy" button is placed within the code block rather than outside it.</li>
  <li>My implementation uses the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Clipboard_API" target="_blank">Clipboard API</a> if the user's browser supports it. However, since it is not yet widely supported, my script falls back to using <code>document.execCommand("copy")</code> if it is unsupported, or if the <code>clipboard-write</code> permission has not been granted.</li>
  <li>"Copy" buttons are only added to <code>code</code> elements that are generated by Chroma.</li>
</ul>

The <a href="https://gohugo.io/content-management/syntax-highlighting/" target="_blank">Hugo highlight shortcode</a> accepts a `line-nos` parameter. If `line-nos` is not specified or `line-nos=inline`, the rendered HTML has this structure:

```html
<div class="highlight">
  <pre class="chroma">
    <code class="language-xxxx">
      (the code we wish to copy)
    </code>
  </pre>
</div>
```

If `line-nos=table`, the HTML is slightly more complicated:

```html
<div class="highlight">
  <div class="chroma">
    <table class="lntable">
      <tbody>
        <tr>
          <td class="lntd">
            (line numbers are rendered here)
          </td>
          <td class="lntd">
            <pre class="chroma">
              <code class="language-xxxx">
                (the code we wish to copy)
              </code>
            </pre>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
```

I use the version with line numbers much more often than the version without, so it is important to me to support both. I decided to place the button inside the <code class="chroma"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"highlight"</span><span class="p">&gt;</span></code> element. Stacking elements on top of one another requires positioning and assigning `z-index` values, which you can see below along with the styling for the "copy" button:

```css
.highlight-wrapper {
  display: block;
  margin: 0 0 1em 0;
}

.highlight {
  position: relative;
  z-index: 0;
  padding: 0;
  margin: 0;
}

.highlight > .chroma {
  position: static;
  z-index: 1;
}

.copy-code-button {
  position: absolute;
  z-index: 2;
  right: 0;
  top: 0;
  font-size: 12px;
  font-weight: 700;
  line-height: 12px;
  letter-spacing: 0.5px;
  width: 60px;
  color: #232326;
  background-color: #7f7f7f;
  border: 1.25px solid #232326;
  border-radius: 4px;
  white-space: nowrap;
  padding: 3px 4px 4px 4px;
  margin: 0 0 0 1px;
  cursor: pointer;
  opacity: 0.6;
}

.copy-code-button:hover,
.copy-code-button:focus,
.copy-code-button:active,
.copy-code-button:active:hover {
  background-color: #b3b3b3;
  opacity: 0.8;
}

.copyable-text-area {
  position: absolute;
  height: 0;
  z-index: -1;
  opacity: .01;
}
```

Did you notice that the CSS includes a selector for a `highlight-wrapper` class that is not present in the HTML structure generated by Chroma? We will create this element and append the positioned elements as a child node, then insert the wrapper into the DOM in place of the <code class="chroma"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"highlight"</span><span class="p">&gt;</span></code> element.

Similarly, the `copyable-text-area` class will be applied to a `textarea` element that will only exist if the Clipboard API is not available. This element will be added to the DOM and have it's value set to the `innerText` value of the `code` we wish to copy. After copying the text, the `textarea` element will be removed fom the DOM. The `height: 0` and `opacity: .01` stylings make it virtually invisible, and `z-index: -1` places it behind the code block.

With that in mind, let's take a look at the JavaScript:

```javascript {linenos=table}
function createCopyButton(highlight) {
  const button = document.createElement("button");
  button.className = "copy-code-button";
  button.type = "button";
  button.innerText = "Copy";
  button.addEventListener("click", () => copyCodeToClipboard(button, highlight));
  addCopyButtonToDom(button, highlight);
}

async function copyCodeToClipboard(button, highlight) {
  const codeElement = highlight.querySelector(":last-child > .chroma > code");
  const codeToCopy = codeElement.innerText;
  try {
    result = await navigator.permissions.query({ name: "clipboard-write" });
    if (result.state == "granted" || result.state == "prompt") {
      await navigator.clipboard.writeText(codeToCopy);
    } else {
      copyCodeBlockExecCommand(codeToCopy, highlight);
    }
  } catch (_) {
    copyCodeBlockExecCommand(codeToCopy, highlight);
  }
  finally {
    codeWasCopied(button);
  }
}

function copyCodeBlockExecCommand(codeToCopy, highlight) {
  const textArea = document.createElement("textArea");
  textArea.className = "copyable-text-area";
  textArea.value = codeToCopy;
  highlight.insertBefore(textArea, highlight.firstChild);
  textArea.select();
  document.execCommand("copy");
  highlight.removeChild(textArea);
}

function codeWasCopied(button) {
  button.blur();
  button.innerText = "Copied!";
  setTimeout(function() {
    button.innerText = "Copy";
  }, 2000);
}

function addCopyButtonToDom(button, highlight) {
  highlight.insertBefore(button, highlight.firstChild);
  const wrapper = document.createElement("div");
  wrapper.className = "highlight-wrapper";
  highlight.parentNode.insertBefore(wrapper, highlight);
  wrapper.appendChild(highlight);
}

document.querySelectorAll(".highlight")
  .forEach(highlight => createCopyButton(highlight));
```

So what does this script do? When the page has fully loaded, a "Copy" button is created for each <code class="chroma"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"highlight"</span><span class="p">&gt;</span></code> element and the `copyCodeToClipboard` function is assigned as the event handler for the button's click event (**Lines 2-6**). Then, `addCopyButtonToDom` is called. Let's examine how this function works:

<div class="code-details">
    <ul>
      <li>
        <p><strong>Line 47: </strong>First, the "Copy" button is inserted into the DOM as the first child of the <code class="chroma"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"highlight"</span><span class="p">&gt;</span></code> element.</p>
      </li>
      <li>
        <p><strong>Line 48-49: </strong>We create a <code>div</code> element to act as a wrapper for the <code class="chroma"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"highlight"</span><span class="p">&gt;</span></code> element and assign the appropriate styling.</p>
      </li>
      <li>
        <p><strong>Line 50-51: </strong>Finally, the wrapper element is inserted into the DOM in the same location as the <code class="chroma"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"highlight"</span><span class="p">&gt;</span></code> element, and the <code class="chroma"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"highlight"</span><span class="p">&gt;</span></code> element is "wrapped" by calling <code>appendChild</code>.</p>
      </li>
    </ul>
</div>

When the user clicks a "Copy" button, the `copyCodeToClipboard` function is called. Since the logic that determines which copy function to use may not seem intuitive, let's go through it together:

<div class="code-details">
    <ul>
      <li>
        <p><strong>Lines 14-15: </strong>Within the try/catch block, we first check if the <code>clipboard-write</code> permission has been granted.</p>
      </li>
      <li>
        <p><strong>Line 16: </strong>If the browser supports the Clipboard API and the <code>clipboard-write</code> permission has been granted, the text within the code block is copied to the clipboard by calling <code>navigator.clipboard.writeText</code>.</p>
      </li>
      <li>
        <p><strong>Line 18: </strong>If the browser supports the Clipboard API but the <code>clipboard-write</code> permission <span class="emphasis">has not been granted</span>, we call <code>copyCodeBlockExecCommand</code>.</p>
      </li>
      <li>
        <p><strong>Lines 21: </strong>If the browser <span class="emphasis">does not</span> support the Clipboard API, an error will be raised and caught. Since this is an expected failure, the error is not re-thrown, and the same action that is performed when the browser supports the Clipboard API but the <code>clipboard-write</code> permission <span class="emphasis">has not been granted</span> is executed &mdash; within the <code>catch</code> block we call <code>copyCodeBlockExecCommand</code>.</p>
      </li>
      <li>
        <p><strong>Line 24: </strong>Code within a <code>finally</code> block is called after either <code>try</code>/<code>catch</code>, regardless of result. Since the "copy" operation was invoked in either <code>try</code>/<code>catch</code> block, we call <code>codeWasCopied</code> which changes the button text to "Copied!". After two seconds the button text is changed back to "Copy".</p>
      </li>
      <li>
        <p><strong>Line 29-30: </strong>When the Clipboard API is unsupported/permission is not granted, we create a <code>textarea</code> element and assign the appropriate styling to make it hidden from the user but still available programmatically.</p>
      </li>
      <li>
        <p><strong>Line 31: </strong>We set the value of the <code>textarea</code> element to be equal the text the user wishes to copy.</p>
      </li>
      <li>
        <p><strong>Line 32: </strong>The <code>textarea</code> element is temporarily aded to the DOM next to the copy button.</p>
      </li>
      <li>
        <p><strong>Line 33-35: </strong>The <code>textarea</code> element is selected before calling <code>document.execCommand("copy")</code>, which copies the text we assigned to the <code>textarea</code> element to the clipboard. After doing so, the <code>textarea</code> element is removed from the DOM.</p>
      </li>
    </ul>
</div>

On this site, the JavaScript in the code block above is bundled with other js files and minified. If you'd like, you can verify the code and debug it using your browser's dev tools on any page that contains a code block (the easiest way would be to inspect the copy button, find the event listeners attached to it and add breakpoints to the method attached to the click handler). I hope this is helpful to you if you use Hugo and have run into the same problem, please leave any feedback/questions in the comments below!
